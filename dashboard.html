<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sanfiat Technologies - Dashboard</title>
    <meta name="description" content="Sanfiat Technologies offers top-notch products and services advertising.">
    <meta property="og:title" content="Sanfiat Technologies">
    <meta property="og:description" content="Leading provider of products and services advertisment.">
    <meta property="og:image" content=images/Photo_1723191951676.png">
    <meta property="og:url" content="https://www.sanfiat-technologies.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="icon" href="images/Photo_1723191951676.png" type="image/x-icon">
    <script type="module">
        import { ensureAuthenticated } from "./script.js";
        
        document.addEventListener("DOMContentLoaded", () => {
            ensureAuthenticated();  // Call the function to ensure the user is authenticated
        });
    </script>    
    <style>
   /* Style for the pop-up modal */
.popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: flex-start; /* Align popup at the top with space below */
    z-index: 1000;
    overflow-y: auto; /* Enable vertical scrolling */
    background: #000;
    background-image: radial-gradient(circle, rgba(255, 255, 255, 0.3) 1%, transparent 20%), 
                      url('images/fallback-stars.jpg'); /* Fallback stars background */
    background-size: 200% 200%, cover;
    background-attachment: fixed; /* Creates a parallax effect */
    animation: starburst 8s infinite alternate ease-in-out;
    padding-bottom: 90px; /* Extra space below popup for scrolling */
}

.popup.hidden {
    display: none; /* Hide the popup when inactive */
}

.popup-content {
    background: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    width: 90%;
    max-width: 400px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.5s ease-in-out;
    margin: 50px auto; /* Adds margin to prevent the popup from sticking at the top */
    position: relative;
}

/* Responsive design */
@media (max-width: 768px) {
    .popup-content {
        padding: 15px;
    }

    .popup-content h3 {
        font-size: 18px;
    }

    .popup-content p, .popup-content ol {
        font-size: 14px;
    }
}

/* Buttons */
.activate-btn, .pay-btn {
    background-color: #28a745;
    color: #fff;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    transition: background-color 0.3s, transform 0.2s;
}

.activate-btn:hover, .pay-btn:hover {
    background-color: #218838;
    transform: scale(1.05);
}

/* Inputs */
input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
}

/* Payment section */
#payment-section {
    margin-top: 20px;
}

/* Starburst animation background */
@keyframes starburst {
    0% {
        background-position: 0 0, 50% 50%;
    }
    100% {
        background-position: 100% 100%, 50% 50%;
    }
}

.hidden {
    display: none;
}

/* Fade in animation */
@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Slide in animation for the popup */
@keyframes slideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Message styling */
.message {
    color: red;
    font-size: 14px;
}

</style>    
    <div id="deposit-header" onclick="window.location.href='deposit.html'">
    Deposit
    </div>
</head>
   <header>
  <a href="index.html">
    <img id="logo" src="images/Photo_1723191951676.png" alt="Logo">
  </a>

  <div class="notification-icon">
    <a href="notifications.html">
      <i class="fas fa-bell"></i>
      <span class="notification-count" id="notification-count">1</span>
    </a>
  </div>

  <div class="profile-icon">
    <a href="profile.html">
      <i class="fas fa-user-circle"></i>
    </a>
  </div>

  <button id="hamburger-icon" class="hamburger-menu">
    <i class="fas fa-bars"></i>
  </button>
</header>
    <div id="balance-section">
    <i class="fas fa-wallet"></i>
    <span>Balance:  Ksh</span>
        </div>

<div id="overlay"></div>

<nav id="mobile-nav" class="mobile-nav">
  <h3>Main Categories</h3>
  <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
  <a href="#" class="has-submenu"><i class="fas fa-box-open"></i> Packages</a>
  <div class="submenu">
    <a href="packages.html"><i class="fas fa-box"></i> Basic</a>
    <a href="packages.html"><i class="fas fa-boxes"></i> Premium</a>
  </div>
  <a href="deposit.html"><i class="fas fa-wallet"></i> Deposit</a>
  <a href="withdrawal.html"><i class="fas fa-hand-holding-usd"></i> Withdraw</a>
  <h3>Other Categories</h3>
  <a href="product.html"><i class="fas fa-box"></i> Products</a>
  <a href="whatsapp-earnings.html"><i class="fab fa-whatsapp"></i> WhatsApp Earnings</a>
  <a href="welcome-bonuses.html"><i class="fas fa-gift"></i> Welcome Bonus</a>
  <a href="cashback-bonuses.html"><i class="fas fa-coins"></i> Cashback Bonus</a>
  <a href="loans.html"><i class="fas fa-money-check-alt"></i> Loans</a>
  <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
  <button type="button" id="logout-button"><i class="fas fa-sign-out-alt"></i> Log Out</button>
  </nav>
<body>
    <div id="payment-popup" class="popup hidden">
        <div class="popup-content">
            <!-- Static message with placeholder for personalization -->
            <div id="welcome-message">
                <h3>Welcome, <span id="firstName">User</span>!</h3>
                <p>
                    Thank you for joining Sanfiat Technologies. To unlock the full potential of this platform and start earning by advertising products from top companies, please activate your account.
                </p>
                <p>To activate your account:</p>
                <ol>
                    <li>Enter your phone number in the field provided below. Make sure it starts with <strong>07</strong>.</li>
                    <li>The amount to be paid is <strong>250 Ksh</strong>, which is already filled in for you.</li>
                    <li>Click the <strong>activate</strong> button to initiate the payment. You will receive an STK push on your phone to approve the payment.</li>
                    <li>Once the payment is successful, please wait as we verify your payment. You will then be allowed to access the platform.</li>
                </ol>
                <p>We look forward to helping you earn and succeed!</p>
            </div>
            <div id="error-message" class="hidden" style="color: red; margin-top: 10px;"></div>
            <button id="activate-btn" class="activate-btn">Activate Account</button>
            <div id="payment-section" class="hidden">
                <label for="phone-number">Enter Phone Number:</label>
                <input type="text" id="phone-number" placeholder="07xxxxxxxx">
    
                <label for="amount-input">Amount to Pay (Ksh):</label>
                <input type="text" id="amount-input" value="250" readonly>
    
                <button id="pay-btn" class="pay-btn">Activate</button>
            </div>
        </div>
    </div>    
    
<section id="dashboard">
            <div id="dashboard-section">
                <section class="dashboard-welcome-box">
                    <h1>Its good to have you on board <span id="firstName"></span>ðŸ’°</h1>
                        <!-- Notification Bar -->
<div id="notification-bar">
    Cashback Offers Activated Successfully: Purchase Standard package @2,800 Receive 5,600KES Cashback, Purchase Ultimate package @6,000 Receive 12,000KES Cashback bonus. All Cashbacks are instant!
    <span class="close-btn" id="close-notification">&times;</span>
</div>
</section>      
                <section id="user-info">
                    <h2>Dashboard</h2> 
                    <div class="info-box" id="name-box">
                        <p>Name: <span id="firstName"></span></p>
                        <i class="fas fa-user"></i>
                        <div class="progress-bar" id="name-progress"></div>
                    </div>
                    <div class="info-box" id="email-box">
                        <p>Email: <span id="user-email"></span></p>
                        <i class="fas fa-envelope"></i>
                        <div class="progress-bar" id="email-progress"></div>
                    </div>
                    <div class="info-box" id="referral-box">
                        <p>Referrals: <span id="referral-count"></span></p>
                        <i class="fas fa-user-friends"></i>
                        <div class="progress-bar" id="referral-progress"></div>
                    </div>
                    <div class="info-box" id="views-box">
                        <p>Total Views: <span id="total-views"></span></p>
                        <i class="fas fa-eye"></i>
                        <div class="progress-bar" id="views-progress"></div>
                    </div>
                    <div class="info-box" id="earnings-box">
                        <p>Total Earnings: <span id="total-earnings"></span> Ksh</p>
                        <i class="fas fa-money-bill-wave"></i>
                        <div class="progress-bar" id="earnings-progress"></div>
                    </div>
                    <div class="info-box" id="amount-box">
                        <p>Amount Deposited: <span id="amount-paid">0</span> Ksh</p>
                        <i class="fas fa-wallet"></i>
                        <div class="progress-bar" id="amount-progress"></div>
                    </div>
                    <div class="info-box" id="package-box">
                        <p>Packages: <span id="package-status"></span></p>
                        <i class="fas fa-box-open"></i>
                        <div class="progress-bar" id="package-progress"></div>
                    </div>
                    <!-- Loading Spinner -->
                    <div id="loading" style="display: none;">
                        <div class="spinner"></div>
                    </div>
                </section>
                 
                <div style="display: flex; align-items: center;">
                    <h3 style="margin-right: 10px;">Your Referral Link:</h3>
                    <p id="referral-link" style="flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0;"></p>
                    <button id="copy-link-button" style="margin-left: 10px; padding: 5px 10px; cursor: pointer;">Copy</button>
                    <a id="whatsapp-share-button" class="button" target="_blank" style="margin-left: 10px; display: inline-block;">
                        <i class="fab fa-whatsapp" style="font-size: 24px; color: #25D366;"></i>
                    </a>
                </div>                                                
                
                <h3>Referred Users</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="referred-users-list">
                        <!-- Referred users will be dynamically inserted here -->
                    </tbody>
                </table>
                

<footer>
    <div class="footer">
        <div class="footer-item">
            <a href="dashboard.html">
                <i class="fas fa-home footer-icon"></i>
                <span>Home</span>
            </a>
        </div>
        <div class="footer-item">
            <a href="deposit.html">
                <i class="fas fa-money-bill-alt footer-icon"></i> 
                <span>Deposit</span>
            </a>
        </div>
        <div class="footer-item">
            <a href="packages.html">
                <i class="fas fa-box-open footer-icon"></i> 
                <span>Packages</span>
            </a>
        </div>
        <div class="footer-item">
            <a href="dashboard.html">
                <i class="fas fa-tachometer-alt footer-icon"></i>
                <span>Dashboard</span>
            </a>
        </div>
        <div class="footer-item">
            <a href="profile.html">
                <i class="fas fa-user-circle footer-icon"></i> 
                <span>Profile</span>
            </a>
        </div>
    </div>
    
    <div class="Button">
        <a href="deposit.html">
            <p class="post-btn">
                <i class="fa fa-plus-square"></i>
            </p>
        </a>
    </div>
</footer>

                
        <p class="copyright-text">&copy; 2024 Sanfiat Technologies. All rights reserved.</p>
        <script type="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"></script>
        <script type="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js"></script>
        <script type="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js"></script>
        <script type="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js"></script>
        <script type="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js"></script>
        
       <!-- Your custom script -->
<script type="module" src="script.js"></script>
<script type="module">
    import { auth, db, doc, getDoc } from './script.js';

    document.addEventListener("DOMContentLoaded", () => {
        const showPaymentPopup = () => {
            const popup = document.getElementById("payment-popup");
            popup.classList.remove("hidden");

            const activateBtn = document.getElementById("activate-btn");
            activateBtn.addEventListener("click", () => {
                const paymentSection = document.getElementById("payment-section");
                paymentSection.classList.remove("hidden");
            });

            const payBtn = document.getElementById("pay-btn");
            payBtn.addEventListener("click", async () => {
                const phoneNumberInput = document.getElementById("phone-number");
                const amountInput = document.getElementById("amount-input");
                const errorMessageDiv = document.getElementById("error-message");

                let phoneNumber = phoneNumberInput.value.trim();
                const amount = amountInput.value;

                // Hide any previous error message
                errorMessageDiv.classList.add("hidden");

                // Ensure the phone number starts with 07 and convert to 254 format
                if (phoneNumber.match(/^07\d{8}$/)) {
                    phoneNumber = phoneNumber.replace(/^0/, "254");
                }

                if (phoneNumber.match(/^254\d{9}$/)) {
                    const user = auth.currentUser;

                    if (user?.email) {
                        try {
                            console.log('Preparing payment payload...');
                            const payload = { phoneNumber, email: user.email, amount };
                            console.log('Payload:', payload);

                            // Disable the button to prevent multiple submissions
                            payBtn.disabled = true;
                            payBtn.textContent = "Processing...";

                            // Send the payment request to the server
                            const response = await fetch("/api/pay", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(payload),
                            });

                            // Re-enable the button after processing
                            payBtn.disabled = false;
                            payBtn.textContent = "Pay";

                            // Check if the response is not OK and handle the error
                            if (!response.ok) {
                                const errorData = await response.json();
                                console.error('Payment API Error:', errorData);
                                throw new Error(errorData.error || "Payment failed.");
                            }

                            // Parse the response and display success message
                            const data = await response.json();
                            console.log('Payment Success:', data);

                            alert(data.message || "Payment initiated successfully. Check your phone for the STK push.");

                            // Poll for payment status
                            const checkPaymentStatus = setInterval(async () => {
                                const statusResponse = await fetch(`/api/check-status/${data.stkResponse.CheckoutRequestID}`);
                                const statusData = await statusResponse.json();

                                if (statusData.status === "Success" || statusData.status === "Failed") {
                                    clearInterval(checkPaymentStatus); // Stop polling

                                    if (statusData.status === "Success") {
                                        alert("Payment was successful! Your balance has been updated.");
                                    } else {
                                        alert("Payment failed. Please try again.");
                                    }
                                    localStorage.setItem("paymentStatus", statusData.status);
                                    location.reload();
                                }
                            }, 5000); // Check status every 5 seconds

                            // Save the payment status in localStorage
                            localStorage.setItem("paymentStatus", "not-paid");

                        } catch (error) {
                            console.error('Error during payment process:', error.message);
                            errorMessageDiv.textContent = `Payment Error: ${error.message}`;
                            errorMessageDiv.classList.remove("hidden");
                        }
                    } else {
                        console.error("Error: User not authenticated.");
                        alert("Error: User not authenticated.");
                    }
                } else {
                    // Highlight the phone number input and show an error message
                    phoneNumberInput.classList.add("error");
                    errorMessageDiv.textContent = "Invalid phone number format. Please use a valid number starting with 07.";
                    errorMessageDiv.classList.remove("hidden");
                }
            });
        };

        const initializeDashboard = async () => {
            const paymentStatus = localStorage.getItem("paymentStatus");

            // Show the payment popup if payment status is "not-paid"
            if (paymentStatus === "not-paid") {
                showPaymentPopup();
            }
        };

        // Initialize the dashboard on page load
        initializeDashboard();
    });
</script>
</body>
</html>
