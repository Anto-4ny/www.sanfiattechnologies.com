<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sanfiat Technologies - Dashboard</title>
    <meta name="description" content="Sanfiat Technologies offers top-notch products and services advertising.">
    <meta property="og:title" content="Sanfiat Technologies">
    <meta property="og:description" content="Leading provider of products and services advertisment.">
    <meta property="og:image" content=images/Photo_1723191951676.png">
    <meta property="og:url" content="https://www.sanfiat-technologies.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="icon" href="images/Photo_1723191951676.png" type="image/x-icon">

<style>
    /* Style for the pop-up modal */
.popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent background */
    display: flex;
    justify-content: center;
    align-items: center;
     z-index: 1000; 
}

.popup-content {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    width: 100%;
    max-width: 400px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

.activate-btn, .pay-btn {
    background-color: #28a745;
    color: #fff;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
}

.activate-btn:hover, .pay-btn:hover {
    background-color: #218838;
}

input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    border: 1px solid #ccc;
}
        /* Basic styling, adjust as needed */
        .hidden { display: none; }
        .show { display: block; }
        .password-toggle { cursor: pointer; }
        #payment-section { margin-top: 20px; }
        .message { color: red; }
    
    </style>
    <div id="deposit-header" onclick="window.location.href='deposit.html'">
    Deposit
    </div>
</head>
   <header>
  <a href="index.html">
    <img id="logo" src="images/Photo_1723191951676.png" alt="Logo">
  </a>

  <div class="notification-icon">
    <a href="notifications.html">
      <i class="fas fa-bell"></i>
      <span class="notification-count" id="notification-count">1</span>
    </a>
  </div>

  <div class="profile-icon">
    <a href="profile.html">
      <i class="fas fa-user-circle"></i>
    </a>
  </div>

  <button id="hamburger-icon" class="hamburger-menu">
    <i class="fas fa-bars"></i>
  </button>
</header>
    <div id="balance-section">
    <i class="fas fa-wallet"></i>
    <span>Balance: 0 Ksh</span>
        </div>

<div id="overlay"></div>

<nav id="mobile-nav" class="mobile-nav">
  <h3>Main Categories</h3>
  <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
  <a href="#" class="has-submenu"><i class="fas fa-box-open"></i> Packages</a>
  <div class="submenu">
    <a href="packages.html"><i class="fas fa-box"></i> Basic</a>
    <a href="packages.html"><i class="fas fa-boxes"></i> Premium</a>
  </div>
  <a href="deposit.html"><i class="fas fa-wallet"></i> Deposit</a>
  <a href="withdrawal.html"><i class="fas fa-hand-holding-usd"></i> Withdraw</a>
  <h3>Other Categories</h3>
  <a href="product.html"><i class="fas fa-box"></i> Products</a>
  <a href="whatsapp-earnings.html"><i class="fab fa-whatsapp"></i> WhatsApp Earnings</a>
  <a href="welcome-bonuses.html"><i class="fas fa-gift"></i> Welcome Bonus</a>
  <a href="cashback-bonuses.html"><i class="fas fa-coins"></i> Cashback Bonus</a>
  <a href="loans.html"><i class="fas fa-money-check-alt"></i> Loans</a>
  <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
  <button type="button" id="logout-button"><i class="fas fa-sign-out-alt"></i> Log Out</button>
  </nav>
<body>
    <div id="payment-popup" class="popup">
        <div class="popup-content">
            <h2>Activate Your Account</h2>
            <p>Your account needs to be activated to access all features.</p>
            <button id="activate-btn" class="activate-btn">Activate Account</button>
    
            
            <div id="payment-section" class="payment-section" style="display: none;">
                <label for="phone-number">Enter your MPESA Number:</label>
                <input
                    type="text"
                    id="phone-number"
                    placeholder="07XXXXXXXX"
                    required
                    pattern="^07\d{8}$"
                    aria-describedby="phone-number-help"
                    title="Phone number should start with '07' and be 10 digits long"
                >
                <small id="phone-number-help" class="form-text text-muted">
                    Please enter a valid MPESA number starting with '07' (e.g., 0712345678).
                </small>
    
                <label for="amount">Amount:</label>
                <input type="text" id="amount" value="250" readonly>
    
                <button id="pay-btn" class="pay-btn">Pay Now</button>
            </div>
        </div>
    </div>
    
     
<section id="dashboard">
            <div id="dashboard-section">
                <section class="dashboard-welcome-box">
                    <h1>Welcome back <span id="firstName"></span>ðŸ’°</h1>
                        <!-- Notification Bar -->
<div id="notification-bar">
    Cashback Offers Activated Successfully: Purchase Standard package @2,800 Receive 5,600KES Cashback, Purchase Ultimate package @6,000 Receive 12,000KES Cashback bonus. All Cashbacks are instant!
    <span class="close-btn" id="close-notification">&times;</span>
</div>
</section>
               <h2>Dashboard</h2>     
                
                
                <section id="user-info">
                    <div class="info-box" id="name-box">
                        <p>Name: <span id="firstName"></span></p>
                        <i class="fas fa-user"></i>
                        <div class="progress-bar" id="name-progress"></div>
                    </div>
                    <div class="info-box" id="email-box">
                        <p>Email: <span id="user-email"></span></p>
                        <i class="fas fa-envelope"></i>
                        <div class="progress-bar" id="email-progress"></div>
                    </div>
                    <div class="info-box" id="referral-box">
                        <p>Referrals: <span id="referral-count"></span></p>
                        <i class="fas fa-user-friends"></i>
                        <div class="progress-bar" id="referral-progress"></div>
                    </div>
                    <div class="info-box" id="views-box">
                        <p>Total Views: <span id="total-views"></span></p>
                        <i class="fas fa-eye"></i>
                        <div class="progress-bar" id="views-progress"></div>
                    </div>
                    <div class="info-box" id="earnings-box">
                        <p>Total Earnings: <span id="total-earnings"></span> Ksh</p>
                        <i class="fas fa-money-bill-wave"></i>
                        <div class="progress-bar" id="earnings-progress"></div>
                    </div>
                    <div class="info-box" id="amount-box">
                        <p>Amount Deposited: <span id="amount-paid">0</span> Ksh</p>
                        <i class="fas fa-wallet"></i>
                        <div class="progress-bar" id="amount-progress"></div>
                    </div>
                    <div class="info-box" id="package-box">
                        <p>Packages: <span id="package-status"></span></p>
                        <i class="fas fa-box-open"></i>
                        <div class="progress-bar" id="package-progress"></div>
                    </div>
                    <!-- Loading Spinner -->
                    <div id="loading" style="display: none;">
                        <div class="spinner"></div>
                    </div>
                </section>
                 
                <div style="display: flex; align-items: center;">
                    <h3 style="margin-right: 10px;">Your Referral Link:</h3>
                    <p id="referral-link" style="flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0;"></p>
                    <button id="copy-link-button" style="margin-left: 10px; padding: 5px 10px; cursor: pointer;">Copy</button>
                    <a id="whatsapp-share-button" class="button" target="_blank" style="margin-left: 10px; display: inline-block;">
                        <i class="fab fa-whatsapp" style="font-size: 24px; color: #25D366;"></i>
                    </a>
                </div>                                                
                
                <h3>Referred Users</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="referred-users-list">
                        <!-- Referred users will be dynamically inserted here -->
                    </tbody>
                </table>
                

<footer>
    <div class="footer">
        <div class="footer-item">
            <a href="dashboard.html">
                <i class="fas fa-home footer-icon"></i>
                <span>Home</span>
            </a>
        </div>
        <div class="footer-item">
            <a href="deposit.html">
                <i class="fas fa-money-bill-alt footer-icon"></i> 
                <span>Deposit</span>
            </a>
        </div>
        <div class="footer-item">
            <a href="packages.html">
                <i class="fas fa-box-open footer-icon"></i> 
                <span>Packages</span>
            </a>
        </div>
        <div class="footer-item">
            <a href="dashboard.html">
                <i class="fas fa-tachometer-alt footer-icon"></i>
                <span>Dashboard</span>
            </a>
        </div>
        <div class="footer-item">
            <a href="profile.html">
                <i class="fas fa-user-circle footer-icon"></i> 
                <span>Profile</span>
            </a>
        </div>
    </div>
    
    <div class="Button">
        <a href="deposit.html">
            <p class="post-btn">
                <i class="fa fa-plus-square"></i>
            </p>
        </a>
    </div>
</footer>

                
        <p class="copyright-text">&copy; 2024 Sanfiat Technologies. All rights reserved.</p>
    <script type ="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"></script>
    <script type ="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js"></script>
    <script type ="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js"></script>
    <script type ="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js"></script>
    <script type ="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js"></script>
    
    <!-- Your custom script using Firebase -->
    <script type="module" src="script.js"></script>
    <script type="module">
        import { auth, db, doc, getDoc } from './script.js';

        document.addEventListener("DOMContentLoaded", () => {
            const checkUserPaymentStatus = async (user) => {
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const paymentStatus = userDoc.data().paymentStatus;
                        if (paymentStatus === "paid") {
                            console.log("User payment verified.");
                            localStorage.setItem("paymentStatus", "paid");
                            return true;
                        } else {
                            console.log("User has not completed payment.");
                            return false;
                        }
                    } else {
                        console.error("User document not found in Firestore.");
                        return false;
                    }
                } catch (error) {
                    console.error("Error checking payment status:", error);
                    return false;
                }
            };

            const showPaymentPopup = () => {
                const popup = document.getElementById("payment-popup");
                if (!popup) {
                    console.error("Payment popup not found.");
                    return;
                }
                popup.style.display = "block";

                const activateBtn = document.getElementById("activate-btn");
                if (activateBtn) {
                    activateBtn.addEventListener("click", () => {
                        const paymentSection = document.getElementById("payment-section");
                        if (paymentSection) {
                            paymentSection.style.display = "block";
                        }
                    });
                }

                const payBtn = document.getElementById("pay-btn");
                if (payBtn) {
                    payBtn.addEventListener("click", async () => {
                        let phoneNumber = document.getElementById("phone-number")?.value.trim();

                        if (phoneNumber.match(/^07\d{8}$/)) {
                            phoneNumber = phoneNumber.replace(/^0/, "254");
                        }

                        if (phoneNumber.match(/^254\d{9}$/)) {
                            const user = auth.currentUser;
                            if (user?.email) {
                                await initiatePayment(phoneNumber, user.email);
                            } else {
                                alert("Error: User not authenticated.");
                            }
                        } else {
                            alert("Invalid phone number format.");
                        }
                    });
                }
            };

            const initiatePayment = async (phoneNumber, email) => {
                try {
                    const response = await fetch("/api/pay", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ phoneNumber, email }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || "Payment failed.");
                    }

                    const data = await response.json();
                    alert(data.message || "Payment initiated successfully.");

                    localStorage.setItem("paymentStatus", "paid");
                    location.reload();
                } catch (error) {
                    console.error("Payment Error:", error.message);
                    alert(`Error: ${error.message}`);
                }
            };

            const initializeDashboard = async (user) => {
                if (!user) {
                    window.location.href = "index.html";
                    return;
                }

                const hasPaid = await checkUserPaymentStatus(user);
                if (!hasPaid) {
                    showPaymentPopup();
                }
            };

            auth.onAuthStateChanged((user) => {
                if (user) {
                    const userEmail = user.email;
                    localStorage.setItem("userEmail", userEmail);
                    initializeDashboard(user);
                } else {
                    window.location.href = "index.html";
                }
            });
        });
    </script>
</body>
</html>
