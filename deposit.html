<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sanfiat Technologies - deposit</title>
    <meta name="description" content="Sanfiat Technologies offers top-notch products and services advertising.">
    <meta property="og:title" content="Sanfiat Technologies">
    <meta property="og:description" content="Leading provider of products and services advertisment.">
    <meta property="og:image" content="images/Photo_1723191951676.png">
    <meta property="og:url" content="https://sanfiat.antocapteknologies.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="icon" href="images/Photo_1723191951676.png" type="image/x-icon">
        <script>
    if (localStorage.getItem('paymentStatus') !== 'paid') {
    window.location.href = 'dashboard.html'; // Redirect to the payment page
}
</script>
<script type="module">
  import { ensureAuthenticated } from "./script.js";

  document.addEventListener("DOMContentLoaded", () => {
      ensureAuthenticated();
  });
</script>

<style>
        /* Basic styling, adjust as needed */
        .hidden { display: none; }
        .show { display: block; }
        .password-toggle { cursor: pointer; }
        #payment-section { margin-top: 20px; }
        .message { color: red; }
    </style>
    <div id="deposit-header" onclick="window.location.href='deposit.html'">
    Deposit
</div
</head>
   <header>
    <a href="index">
      <img id="logo" src="images/Photo_1723191951676.png" alt="Logo">
    </a>
  
    <div class="notification-icon">
      <a href="notifications">
        <i class="fas fa-bell"></i>
        <span class="notification-count" id="notification-count">1</span>
      </a>
    </div>
  
    <div class="profile-icon">
      <a href="profile">
        <i class="fas fa-user-circle"></i>
      </a>
    </div>
  
    <button id="hamburger-icon" class="hamburger-menu">
      <i class="fas fa-bars"></i>
    </button>
  </header>
  <div id="balance-section">
      <i class="fas fa-wallet"></i>
      <span>Balance: 250 Ksh</span>
          </div>
  
  <div id="overlay"></div>
  
  <nav id="mobile-nav" class="mobile-nav">
      <h3>Browse Sanfiat</h3>
      <a href="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      <a href="#" class="has-submenu"><i class="fab fa-whatsapp"></i> WhatsApp Earnings</a>
      <div class="submenu">
        <a href="whatsapp-earnings"><i class="fab fa-whatsapp"></i> Earned</a>
        <a href="packages"><i class="fas fa-box"></i> WhatsApp Packages</a>
        <a href="product"><i class="fas fa-box"></i> Daily Product</a>
        <a href="upload"><i class="fab fa-whatsapp"></i> Screenshot Upload</a>
        <a href="withdrawal"><i class="fas fa-money-check-alt"></i> Withdraw</a>
      </div>
      <a href="packages"><i class="fas fa-box"></i> WhatsApp Packages</a>
      <a href="deposit"><i class="fas fa-wallet"></i> Deposit</a>
      <a href="withdrawal"><i class="fas fa-hand-holding-usd"></i> Withdraw</a>
      <a href="product"><i class="fas fa-box"></i> Products</a>
      <a href="welcome-bonuses"><i class="fas fa-gift"></i> Welcome Bonus</a>
      <a href="cashback-bonuses"><i class="fas fa-coins"></i> Cashback Bonus</a>
      <a href="loans"><i class="fas fa-money-check-alt"></i> Loans</a>
      <a href="profile"><i class="fas fa-user"></i> Profile</a>
      <button type="button" id="logout-button"><i class="fas fa-sign-out-alt"></i> Log Out</button>
      </nav>    
<main>

  <!-- Payment Section -->
  <div id="payment-section" style="
      width: 90%;
      max-width: 500px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      background-color: #f9f9f9;
      font-family: Arial, sans-serif;
    ">
    <h3 style="text-align: center; color: #4CAF50; margin-bottom: 15px; font-size: 1.5em;">
      Make a Payment
    </h3>

    <img src="images/Icons/images.jpeg" alt="MPESA Logo" style="display: block; margin: 0 auto 20px; width: 80px; height: auto;">

    <p style="font-size: 0.9em; color: #555; text-align: center;">
      To complete your payment via MPESA, follow the steps below:
    </p>

    <ol style="padding-left: 15px; font-size: 0.9em; color: #444;">
      <li>Enter your phone number and amount below.</li>
      <li>Click the "Deposit" button.</li>
      <li>A pop-up will prompt you for your MPESA PIN.</li>
      <li>Copy and paste the transaction code below.</li>
    </ol>

    <!-- Phone Number Input -->
    <label for="phone-number" style="display: block; margin-top: 10px; font-weight: bold;">Enter Your Phone Number:</label>
    <input type="text" id="phone-number" placeholder="07XX XXX XXX" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">

    <small id="phone-number-error" style="color: red;"></small> <!-- Error message -->

   <!-- Suggested Amounts -->
<div style="margin: 15px 0;">
  <p style="font-weight: bold;">Select an Amount:</p>
  <div style="display: flex; flex-wrap: wrap; gap: 10px;">
    <button type="button" class="amount-suggestion" style="padding: 8px 12px; border: none; border-radius: 5px; background-color: #4CAF50; color: white; cursor: pointer; font-size: 0.9em;" onclick="setAmount(500)">500</button>
    <button class="amount-suggestion" onclick="setAmount(250)">250</button>
    <button class="amount-suggestion" onclick="setAmount(680)">680</button>
    <button class="amount-suggestion" onclick="setAmount(900)">900</button>
    <button class="amount-suggestion" onclick="setAmount(6000)">6000</button>
    <button class="amount-suggestion" onclick="setAmount(1000)">1000</button>
  </div>
</div>


    <!-- Amount Input -->
    <label for="amount" style="display: block; font-weight: bold;">Enter Amount to Deposit:</label>
    <input type="number" id="amount" placeholder="e.g. 500" style="width: 100%; padding: 8px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">
    
    <small id="amount-error" style="color: red;"></small> <!-- Error message -->

    <!-- Pay Button -->
    <button id="pay-button" style="width: 100%; padding: 10px; border: none; border-radius: 5px; background-color: #4CAF50; color: white; font-size: 1em; cursor: pointer; margin-bottom: 15px;">
     Deposit <span id="package-amount"></span>
    </button>

    <!-- MPESA Code Input -->
    <label for="payment-confirmation" style="display: block; font-weight: bold;">Enter MPESA Code:</label>
    <input type="text" id="payment-confirmation" placeholder="MPESA Transaction Code" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">

    <!-- Submit Payment Button -->
    <button id="submit-payment" style="width: 100%; margin-top: 15px; padding: 10px; border: none; border-radius: 5px; background-color: #2196F3; color: white; font-size: 1em; cursor: pointer;">
      Submit Payment Code
    </button>

    <p id="payment-status" style="margin-top: 15px; text-align: center; color: red;"></p>
  </div>

  <!-- Confirmation Section (Initially Hidden) -->
  <div id="confirmation-section" style="display: none; width: 90%; max-width: 500px; margin: 20px auto; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); background-color: #f9f9f9; font-family: Arial, sans-serif;">
    <h3 style="text-align: center; color: #4CAF50; font-size: 1.5em;">
      Business Payment Details
    </h3>
    <p style="text-align: center; font-size: 1.1em;">
      <strong>Till Number:</strong> 4904474
    </p>

    <!-- MPESA Code Confirmation -->
    <label for="confirm-mpesa-code" style="display: block; margin-top: 10px; font-weight: bold;">
      Enter MPESA Code:
    </label>
    <input type="text" id="confirm-mpesa-code" placeholder="MPESA Transaction Code" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">

    <button id="submit-confirmation" style="width: 100%; margin-top: 15px; padding: 10px; border: none; border-radius: 5px; background-color: #2196F3; color: white; font-size: 1em; cursor: pointer;">
      Submit Payment Code
    </button>
  </div>
</main>

      
    <footer>
    <div class="Button">
        <a href="deposit">
            <p class="post-btn">
                <i class="fa fa-plus-square"></i>
            </p>
        </a>
    </div>
    </footer>
    
        <p class="copyright-text">&copy; 2024 Sanfiat Technologies. All rights reserved.</p>
        <script type ="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"></script>
        <script type ="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js"></script>
        <script type ="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js"></script>
        <script type ="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js"></script>
        <script type ="module" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js"></script>
        
    <!-- Your custom script using Firebase -->
    <script type="module" src="script.js"></script>
    <script type="module">
      import { auth, db, doc, getDoc } from "./script.js";
    
      document.addEventListener("DOMContentLoaded", () => {
        // Extract package info from query parameters
        function getQueryParams() {
          const queryString = window.location.search;
          const urlParams = new URLSearchParams(queryString);
          const packageName = urlParams.get("packageName");
          const packagePrice = urlParams.get("packagePrice");
    
          // Display package price if valid
          if (packagePrice && !isNaN(packagePrice)) {
            document.getElementById("package-amount").textContent = `${packagePrice} Ksh`;
            document.getElementById("amount").value = packagePrice;
          } else {
            console.error("Invalid or missing package price in URL parameters.");
            document.getElementById("package-amount").textContent = "Error: Invalid package price.";
          }
    
          return { packageName, packagePrice };
        }
    
        // Fetch user's email from Firebase Auth
        const getUserEmail = () => {
          const user = auth.currentUser;
          return user ? user.email : null;
        };
    
        // Phone number validation
        const phoneNumberInput = document.getElementById("phone-number");
        const phoneNumberError = document.getElementById("phone-number-error");
    
        phoneNumberInput.addEventListener("input", function () {
          const phoneNumber = phoneNumberInput.value.trim();
          if (!phoneNumber.match(/^07\d{8}$/)) {
            phoneNumberError.textContent = "Invalid phone number. Please enter a valid MPESA number.";
            phoneNumberError.style.color = "red";
          } else {
            phoneNumberError.textContent = "";
          }
        });
    
        // Payment initiation
        document.getElementById("pay-button").addEventListener("click", async function () {
          let phoneNumber = phoneNumberInput.value.trim();
          const amount = document.getElementById("amount").value.trim();
          const email = getUserEmail();
    
          // Normalize phone number to international format
          if (phoneNumber.match(/^07\d{8}$/)) {
            phoneNumber = phoneNumber.replace(/^0/, "254");
          }
    
          // Ensure valid input
          if (!phoneNumber.match(/^254\d{9}$/)) {
            phoneNumberError.textContent = "Invalid phone number format.";
            phoneNumberError.style.color = "red";
            return;
          }
          if (!amount || isNaN(amount) || amount <= 0) {
            alert("Please enter a valid amount.");
            return;
          }
          if (!email) {
            alert("You need to be logged in to proceed.");
            return;
          }
    
          // Initiate payment
          try {
            const payload = { phoneNumber, amount, email };
            const response = await fetch("/api/pay", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });
    
            const data = await response.json();
    
            if (response.ok && data.status === "Success") {
              alert(data.message || "Payment initiation successful. Check your phone for the MPESA STK push.");
              document.getElementById("confirmation-section").style.display = "block";
            } else {
              throw new Error(data.error || "Payment initiation failed. Please try again.");
            }
          } catch (error) {
            console.error("Payment initiation error:", error);
            alert(`Error: ${error.message}`);
          }
        });
    
        // Check payment status on page load
        const checkUserPaymentStatus = async () => {
          try {
            const user = auth.currentUser;
            if (!user) {
              console.error("No user logged in.");
              window.location.href = "index"; // Redirect to login page
              return false;
            }
    
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().paymentStatus === "paid") {
              console.log("User payment verified.");
              localStorage.setItem("paymentStatus", "paid"); // Save in local storage
              return true;
            } else {
              console.warn("User has not completed payment.");
              return false;
            }
          } catch (error) {
            console.error("Error checking payment status:", error);
            return false;
          }
        };
    
        // Initialize payment handling
        const initializePayment = async () => {
          const user = auth.currentUser;
          if (!user) {
            window.location.href = "index.html"; // Redirect if not logged in
            return;
          }
    
          const hasPaid = await checkUserPaymentStatus();
          if (!hasPaid) {
            document.getElementById("payment-section").style.display = "block";
          }
        };
    
        // Handle Firebase Auth state
        auth.onAuthStateChanged((user) => {
          if (user) {
            console.log("User authenticated:", user.email);
            initializePayment();
          } else {
            console.log("No user authenticated. Redirecting to login...");
            window.location.href = "index";
          }
        });
    
        // Parse query parameters and populate the UI
        getQueryParams();
    
        // Amount suggestion buttons
        document.querySelectorAll(".amount-suggestion").forEach((button) => {
          button.addEventListener("click", () => {
            const amount = button.textContent.trim();
            document.getElementById("amount").value = amount;
          });
        });
      });
    </script>        
</body>
</html>
